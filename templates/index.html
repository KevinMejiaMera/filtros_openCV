<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenCV Studio Pro</title>
  <!-- Google Fonts: Outfit (Modern Sans Video) -->
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      /* Palette: Dark & Premium */
      --bg-dark: #0f172a;
      /* Slate 900 */
      --bg-card: #1e293b;
      /* Slate 800 */
      --primary: #38bdf8;
      /* Sky 400 */
      --secondary: #818cf8;
      /* Indigo 400 */
      --accent: #f472b6;
      /* Pink 400 */
      --success: #2dd4bf;
      /* Teal 400 */
      --text-main: #f1f5f9;
      /* Slate 100 */
      --text-muted: #94a3b8;
      /* Slate 400 */
      --gradient-main: linear-gradient(135deg, #38bdf8 0%, #818cf8 100%);
      --glass-bg: rgba(30, 41, 59, 0.7);
      --glass-border: 1px solid rgba(255, 255, 255, 0.1);
      --radius-lg: 16px;
      --radius-md: 12px;
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-main);
      min-height: 100vh;
      overflow-x: hidden;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(56, 189, 248, 0.1) 0%, transparent 40%),
        radial-gradient(circle at 90% 80%, rgba(129, 140, 248, 0.1) 0%, transparent 40%);
    }

    /* --- Header --- */
    header {
      text-align: center;
      padding: 40px 20px;
      position: relative;
    }

    h1 {
      font-size: 3.5rem;
      font-weight: 700;
      background: var(--gradient-main);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
      letter-spacing: -1px;
    }

    header p {
      color: var(--text-muted);
      font-size: 1.2rem;
      font-weight: 300;
    }

    .container {
      max-width: 1400px;
      /* Wider for bigger images */
      margin: 0 auto;
      padding: 0 20px 40px;
    }

    /* --- Components --- */
    .glass-card {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      border: var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 30px;
      box-shadow: var(--shadow-lg);
      margin-bottom: 30px;
      transition: transform 0.3s ease;
    }

    .glass-card:hover {
      border-color: rgba(56, 189, 248, 0.3);
    }

    .section-title {
      font-size: 1.5rem;
      color: var(--text-main);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title i {
      color: var(--primary);
    }

    /* --- Forms & Buttons --- */
    .control-group {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    input[type="file"] {
      display: none;
    }

    .file-label {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px 25px;
      border-radius: var(--radius-md);
      cursor: pointer;
      border: 1px dashed var(--text-muted);
      transition: all 0.3s;
      flex: 1;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .file-label:hover {
      background: rgba(56, 189, 248, 0.1);
      border-color: var(--primary);
      color: var(--primary);
    }

    select {
      background: var(--bg-dark);
      color: var(--text-main);
      border: var(--glass-border);
      padding: 15px 20px;
      border-radius: var(--radius-md);
      outline: none;
      cursor: pointer;
      font-family: inherit;
      font-size: 1rem;
      flex: 1;
      min-width: 200px;
    }

    select:focus {
      border-color: var(--primary);
    }

    .btn-primary {
      background: var(--gradient-main);
      color: white;
      border: none;
      padding: 15px 40px;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      font-size: 1.1rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 15px rgba(56, 189, 248, 0.3);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(56, 189, 248, 0.4);
    }

    /* --- Local Gallery (Horizontal Scroll) --- */
    .gallery-container {
      display: flex;
      gap: 20px;
      overflow-x: auto;
      padding-bottom: 15px;
      scrollbar-width: thin;
      scrollbar-color: var(--primary) var(--bg-dark);
    }

    .gallery-item {
      flex: 0 0 160px;
      /* Fixed width cards */
      position: relative;
      border-radius: var(--radius-md);
      overflow: hidden;
      border: 1px solid transparent;
      transition: all 0.3s;
      background: rgba(0, 0, 0, 0.2);
    }

    .gallery-item:hover {
      border-color: var(--primary);
      transform: scale(1.05);
      z-index: 10;
    }

    .gallery-thumb {
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
    }

    .gallery-actions {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .gallery-actions select {
      padding: 5px;
      font-size: 0.8rem;
      min-width: 0;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
    }

    .gallery-actions button {
      width: 100%;
      padding: 5px;
      background: var(--primary);
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      font-size: 0.8rem;
    }

    /* --- Results Area (The Centerpiece) --- */
    .results-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      margin-bottom: 40px;
      align-items: start;
    }

    /* For very larger screens or if only 1 image */
    .full-width {
      grid-column: 1 / -1;
    }

    .image-display {
      position: relative;
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      background: #000;
    }

    .image-display img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: var(--radius-lg);
    }

    .label-overlay {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 500;
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 2;
    }

    /* Info Card under results */
    .info-panel {
      grid-column: 1 / -1;
      background: rgba(56, 189, 248, 0.05);
      border-left: 4px solid var(--primary);
      padding: 20px;
      border-radius: 0 var(--radius-md) var(--radius-md) 0;
    }

    /* --- BGR Channels (Small bottom row) --- */
    .channels-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-top: 20px;
    }

    .channel-item {
      text-align: center;
    }

    .channel-item h4 {
      margin-bottom: 10px;
      font-weight: 500;
    }

    .channel-item img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: var(--radius-md);
      opacity: 0.8;
      transition: opacity 0.3s;
    }

    .channel-item img:hover {
      opacity: 1;
    }

    /* --- Camera Section --- */
    .cam-feed {
      width: 100%;
      max-width: 800px;
      border-radius: var(--radius-lg);
      border: 2px solid var(--accent);
      box-shadow: 0 0 20px rgba(244, 114, 182, 0.3);
      display: block;
      margin: 0 auto;
    }

    /* --- Footer --- */
    footer {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    /* --- Utility --- */
    .hidden {
      display: none;
    }

    @media (max-width: 900px) {
      .results-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>OpenCV Studio <span style="color:var(--primary); font-size: 1.5rem; vertical-align: super;">PRO</span></h1>
      <p>Suite Profesional de Algoritmos de Visión por Computadora</p>
    </header>

    <!-- 1. Upload & Process Section -->
    <div class="glass-card">
      <h2 class="section-title"><i class="fas fa-magic"></i> Nuevo procesamiento</h2>
      <form action="/upload" method="POST" enctype="multipart/form-data">
        <div class="control-group">
          <label class="file-label">
            <i class="fas fa-cloud-upload-alt fa-lg"></i>
            <input type="file" name="file" id="fileInput" required onchange="updateFileName(this)">
            <span id="fileName">Seleccionar archivo...</span>
          </label>
          <select name="filtro">
            <option value="" disabled selected>Selecciona un filtro...</option>
            <optgroup label="Detección & Líneas (Segmentación)">
              <option value="hough">Hough Líneas (Probabilístico)</option>
              <option value="hough_standard">Hough Líneas (Estándar)</option>
              <option value="hough_circles">Hough Círculos</option>
              <option value="canny">Detector Canny</option>
              <option value="sobel">Sobel</option>
              <option value="scharr">Scharr</option>
              <option value="prewitt">Prewitt</option>
              <option value="roberts">Roberts</option>
              <option value="laplaciano">Laplaciano</option>
              <option value="log">Laplaciano del Gaussiano (LoG)</option>
            </optgroup>
            <optgroup label="Restauración & Suavizado">
              <option value="bilateral">Filtro Bilateral (Pro)</option>
              <option value="gaussiano">Desenfoque Gaussiano</option>
              <option value="mediana">Filtro Mediana</option>
              <option value="blur">Promedio Simple</option>
            </optgroup>
            <optgroup label="Morfología Matemática">
              <option value="gradiente">Gradiente Morfológico</option>
              <option value="erosion">Erosión</option>
              <option value="dilatacion">Dilatación</option>
              <option value="apertura">Apertura</option>
              <option value="cierre">Cierre</option>
            </optgroup>
            <optgroup label="Segmentación & Umbral">
              <option value="threshold">Brinario Simple</option>
              <option value="adaptive">Adaptativo</option>
              <option value="otsu">Otsu</option>
            </optgroup>
          </select>
        </div>
        <button type="submit" class="btn-primary" style="width: 100%;">
          <i class="fas fa-bolt"></i> Procesar Imagen
        </button>
      </form>
    </div>

    <!-- 2. Local Gallery (Quick Select) -->
    <div class="glass-card">
      <h2 class="section-title"><i class="fas fa-folder-open"></i> Galería Local</h2>
      {% if local_images %}
      <div class="gallery-container">
        {% for image in local_images %}
        <div class="gallery-item">
          <img src="{{ url_for('static', filename='img/' + image) }}" class="gallery-thumb" alt="{{ image }}">
          <form action="/process_local" method="POST" class="gallery-actions">
            <input type="hidden" name="image_name" value="{{ image }}">
            <select name="filtro">
              <optgroup label="Main">
                <option value="hough">Hough Lines</option>
                <option value="canny">Canny</option>
                <option value="sobel">Sobel</option>
                <option value="bilateral">Bilateral</option>
              </optgroup>
              <optgroup label="Advanced">
                <option value="hough_standard">Hough Standard</option>
                <option value="scharr">Scharr</option>
                <option value="log">LoG</option>
              </optgroup>
            </select>
            <button type="submit">Procesar</button>
          </form>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p style="color: var(--text-muted); text-align: center;">No hay imágenes en la carpeta <code>static/img</code></p>
      {% endif %}
    </div>

    <!-- 3. Results Preview (Shows ONLY if processing happened) -->
    {% if original_image %}
    <div id="results" class="glass-card" style="border-color: var(--primary);">
      <h2 class="section-title"><i class="fas fa-chart-bar"></i> Resultados del Análisis</h2>

      <div class="results-grid">
        <!-- Original -->
        <div class="image-display">
          <div class="label-overlay">Original</div>
          <img src="{{ original_image }}" alt="Original">
        </div>
        <!-- Processed -->
        <div class="image-display">
          <div class="label-overlay" style="background: var(--primary);">{{ filtro|capitalize }}</div>
          <img src="{{ processed_image }}" alt="Procesada">
        </div>

        <!-- Analysis Info -->
        <div class="info-panel">
          <h3><i class="fas fa-info-circle"></i> Insight Técnico</h3>
          <p style="margin-top: 10px; font-size: 1.1rem; line-height: 1.6;">{{ descripcion }}</p>
        </div>
      </div>

      <!-- BGR Channels -->
      <h3 style="margin-top: 30px; margin-bottom: 20px;">Descomposición de Canales</h3>
      <div class="channels-grid">
        <div class="channel-item">
          <h4 style="color: #3b82f6;">Blue Channel</h4>
          <img src="{{ blue_image }}" alt="Blue">
        </div>
        <div class="channel-item">
          <h4 style="color: #22c55e;">Green Channel</h4>
          <img src="{{ green_image }}" alt="Green">
        </div>
        <div class="channel-item">
          <h4 style="color: #ef4444;">Red Channel</h4>
          <img src="{{ red_image }}" alt="Red">
        </div>
      </div>
    </div>
    <script>
      // Auto-scroll to results on load
      window.location.hash = "results";
    </script>
    {% endif %}

    <!-- 4. Camera Section -->
    <div class="glass-card">
      <h2 class="section-title"><i class="fas fa-video"></i> Laboratorio en Vivo</h2>

      {% if not camara %}
      <form action="/iniciar_camara" method="POST" style="text-align: center; padding: 40px;">
        <p style="margin-bottom: 20px; color: var(--text-muted);">Activa la cámara web para aplicar filtros en tiempo
          real.</p>
        <button type="submit" class="btn-primary" style="background: var(--bg-card); border: 1px solid var(--primary);">
          <i class="fas fa-power-off"></i> Iniciar Cámara
        </button>
      </form>
      {% else %}
      <div style="text-align: center;">
        <div class="control-group" style="justify-content: center; margin-bottom: 20px;">
          <form action="/aplicar_filtro_camara" method="POST" style="display: flex; gap: 10px;">
            <select name="filtro">
              <option value="">Normal (Sin filtro)</option>
              <option value="canny">Detector Canny</option>
              <option value="hough">Hough Líneas</option>
              <option value="sobel">Sobel</option>
              <option value="laplaciano">Laplaciano</option>
              <option value="threshold">Binario</option>
            </select>
            <button type="submit" class="btn-primary" style="padding: 10px 20px; font-size: 0.9rem;">Cambiar</button>
          </form>
          <form action="/detener_camara" method="POST">
            <button type="submit" class="btn-primary"
              style="background: #ef4444; padding: 10px 20px; font-size: 0.9rem;">Detener</button>
          </form>
        </div>
        <img src="{{ url_for('video_feed') }}" class="cam-feed" alt="Live Feed">
      </div>
      {% endif %}
    </div>

  </div>

  <footer>
    <p>&copy; 2025 OpenCV Studio. Developed for Advanced Image Processing.</p>
  </footer>

  <script>
    function updateFileName(input) {
      const fileNameSpan = document.getElementById('fileName');
      if (input.files && input.files.length > 0) {
        fileNameSpan.textContent = input.files[0].name;
        fileNameSpan.style.color = 'var(--primary)';
      } else {
        fileNameSpan.textContent = 'Seleccionar archivo...';
        fileNameSpan.style.color = 'inherit';
      }
    }
  </script>
</body>

</html>